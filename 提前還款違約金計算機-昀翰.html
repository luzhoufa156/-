
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>提前還款違約金計算機（特記事項）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }
    h1 {
      font-size: 24px;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px 24px;
      margin-bottom: 16px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    label {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }
    .hint {
      font-size: 12px;
      color: #6b7280;
    }
    input[type="date"],
    input[type="text"] {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      width: 100%;
    }
    .currency-input {
      text-align: right;
    }
    input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb22;
    }
    .balances-card {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 12px 14px;
      background: #f9fafb;
      margin-bottom: 16px;
    }
    .balances-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .balances-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px 14px;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0 18px;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 18px;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .btn-primary {
      background: #2563eb;
      color: #ffffff;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }
    .btn-outline {
      background: #ffffff;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    .btn-outline:hover {
      background: #f3f4f6;
    }
    .result-card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 16px 18px;
      background: #f9fafb;
      margin-top: 8px;
    }
    .result-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 10px;
    }
    .result-main {
      font-size: 24px;
      font-weight: 700;
    }
    .result-main small {
      font-size: 13px;
      font-weight: 500;
      color: #6b7280;
      margin-left: 4px;
    }
    .chip {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      border: 1px solid #bae6fd;
    }
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 6px 18px;
      font-size: 13px;
      margin-top: 6px;
    }
    .result-item-label {
      color: #6b7280;
    }
    .result-item-value {
      font-weight: 600;
      color: #111827;
      word-break: break-all;
    }
    .note {
      margin-top: 10px;
      font-size: 11px;
      color: #6b7280;
      line-height: 1.5;
    }
    .error {
      margin-top: 8px;
      font-size: 12px;
      color: #b91c1c;
    }

    @media print {
      body {
        background: #ffffff;
        padding: 0;
      }
      .container {
        box-shadow: none;
        border-radius: 0;
        max-width: 100%;
      }
      .btn-row {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>提前還款違約金計算機（特記事項）</h1>
    <div class="subtitle">
      依「限制清償期間」特記事項：
      自撥付日起 6 個月內 1％、6–24 個月內 0.8％、24–36 個月內 0.5％，
      以結清前 6 個月每月底借款餘額平均數為基礎計算違約金。
    </div>

    <div class="grid">
      <div class="field">
        <label for="customerName">客戶姓名</label>
        <input type="text" id="customerName" placeholder="例如：王小明" />
      </div>
    </div>

    <div class="grid">
      <div class="field">
        <label for="disburseDate">撥付日</label>
        <input type="date" id="disburseDate" />
        <div class="hint">貸款實際撥款日</div>
      </div>
      <div class="field">
        <label for="prepayDate">結清日（預計清償日）</label>
        <input type="date" id="prepayDate" />
        <div class="hint">辦理提前清償並塗銷抵押權之日期</div>
      </div>
    </div>

    <div class="balances-card">
      <div class="balances-title">結清前每月底借款餘額（最多填寫最近 6 個月）</div>
      <div class="hint" style="margin-bottom:8px;">
        依約定以「結清前 6 個月內，每月底之借款餘額平均數」作為計算基礎；
        如未滿 6 個月，則以實際月數平均。金額會自動顯示為三位數一逗號。
      </div>
      <div class="balances-grid">
        <div class="field">
          <label for="bal1">最近 1 個月底餘額</label>
          <input type="text" id="bal1" class="currency-input" placeholder="例如 1,000,000" />
        </div>
        <div class="field">
          <label for="bal2">最近 2 個月底餘額</label>
          <input type="text" id="bal2" class="currency-input" placeholder="選填" />
        </div>
        <div class="field">
          <label for="bal3">最近 3 個月底餘額</label>
          <input type="text" id="bal3" class="currency-input" placeholder="選填" />
        </div>
        <div class="field">
          <label for="bal4">最近 4 個月底餘額</label>
          <input type="text" id="bal4" class="currency-input" placeholder="選填" />
        </div>
        <div class="field">
          <label for="bal5">最近 5 個月底餘額</label>
          <input type="text" id="bal5" class="currency-input" placeholder="選填" />
        </div>
        <div class="field">
          <label for="bal6">最近 6 個月底餘額</label>
          <input type="text" id="bal6" class="currency-input" placeholder="選填" />
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn-primary" onclick="calculatePenalty()">計算違約金</button>
      <button class="btn-outline" type="button" onclick="resetForm()">清除重填</button>
      <button class="btn-outline" type="button" onclick="window.print()">列印本頁</button>
    </div>

    <div id="error" class="error" style="display:none;"></div>

    <div id="result" class="result-card" style="display:none;">
      <div class="result-header">
        <div class="result-main">
          <span id="penaltyAmount">0</span>
          <small>元（試算結果）</small>
        </div>
        <div id="periodTag" class="chip"></div>
      </div>
      <div class="result-grid">
        <div>
          <div class="result-item-label">客戶姓名</div>
          <div class="result-item-value" id="resCustomerName"></div>
        </div>
        <div>
          <div class="result-item-label">撥付日至結清日區間</div>
          <div class="result-item-value" id="monthRange"></div>
        </div>
        <div>
          <div class="result-item-label">適用違約金比率</div>
          <div class="result-item-value" id="rateText"></div>
        </div>
        <div>
          <div class="result-item-label">平均借款餘額（計算基礎）</div>
          <div class="result-item-value" id="avgBalance"></div>
        </div>
        <div>
          <div class="result-item-label">計算說明</div>
          <div class="result-item-value" id="formulaText"></div>
        </div>
      </div>
      <div class="note">
        ※ 本工具僅為內部試算輔助，實際違約金金額仍以農會系統計算及契約約定為準。<br />
        ※ 未超過 36 個月者，違約金為 0；如遇特殊案件條款或總主任裁量，請再個案確認。
      </div>
    </div>
  </div>

  <script>
    function addMonths(date, months) {
      const d = new Date(date.getTime());
      const day = d.getDate();
      d.setMonth(d.getMonth() + months);

      // 若原日期為月底而導致溢位，例如 1/31 + 1 個月 → 3/3，則往前調整到該月最後一天
      if (d.getDate() < day) {
        d.setDate(0);
      }
      return d;
    }

    function formatNumber(num) {
      if (isNaN(num)) return "0";
      return num.toLocaleString("zh-TW", { maximumFractionDigits: 0 });
    }

    function monthsDiff(start, end) {
      const years = end.getFullYear() - start.getFullYear();
      const months = end.getMonth() - start.getMonth();
      const total = years * 12 + months;
      // 若結清日日期小於撥付日日期，視為尚未滿該「整月」，扣 1 個月
      return end.getDate() >= start.getDate() ? total : total - 1;
    }

    function calculatePenalty() {
      const errorEl = document.getElementById("error");
      const resultEl = document.getElementById("result");
      errorEl.style.display = "none";
      resultEl.style.display = "none";
      errorEl.textContent = "";

      const disburseStr = document.getElementById("disburseDate").value;
      const prepayStr = document.getElementById("prepayDate").value;

      if (!disburseStr || !prepayStr) {
        errorEl.textContent = "請先輸入撥付日與結清日。";
        errorEl.style.display = "block";
        return;
      }

      const disburseDate = new Date(disburseStr);
      const prepayDate = new Date(prepayStr);

      if (prepayDate < disburseDate) {
        errorEl.textContent = "結清日不可早於撥付日，請重新確認。";
        errorEl.style.display = "block";
        return;
      }

      // 取得 6 個月底餘額，僅計算有填寫且大於 0 的數值
      const balances = [];
      for (let i = 1; i <= 6; i++) {
        const rawVal = document.getElementById("bal" + i).value.replace(/,/g, "");
        if (rawVal !== "" && !isNaN(rawVal)) {
          const num = parseFloat(rawVal);
          if (num > 0) balances.push(num);
        }
      }
      if (balances.length === 0) {
        errorEl.textContent = "請至少輸入一個結清前月底借款餘額。";
        errorEl.style.display = "block";
        return;
      }

      const sum = balances.reduce((acc, v) => acc + v, 0);
      const avg = sum / balances.length;

      // 依特記事項期間決定比率
      const mDiff = monthsDiff(disburseDate, prepayDate); // 滿幾個「整月」
      const mDiffDisplay = mDiff; // 可直接顯示整月數

      const d6 = addMonths(disburseDate, 6);
      const d24 = addMonths(disburseDate, 24);
      const d36 = addMonths(disburseDate, 36);

      let rate = 0;
      let periodText = "";
      let rateText = "";

      if (prepayDate <= d6) {
        rate = 0.01;
        periodText = "自撥付日起 6 個月內清償";
        rateText = "1％";
      } else if (prepayDate > d6 && prepayDate <= d24) {
        rate = 0.008;
        periodText = "超過 6 個月且在 24 個月內清償";
        rateText = "0.8％";
      } else if (prepayDate > d24 && prepayDate <= d36) {
        rate = 0.005;
        periodText = "超過 24 個月且在 36 個月內清償";
        rateText = "0.5％";
      } else {
        rate = 0;
        periodText = "超過 36 個月，不收違約金";
        rateText = "0％（不計收）";
      }

      const penalty = Math.round(avg * rate);

      // 客戶姓名
      const customerName = document.getElementById("customerName").value.trim();
      document.getElementById("resCustomerName").textContent = customerName || "—";

      // 輸出結果
      document.getElementById("penaltyAmount").textContent = formatNumber(penalty);
      document.getElementById("periodTag").textContent = periodText;
      document.getElementById("monthRange").textContent =
        mDiffDisplay + " 個整月（約）";
      document.getElementById("rateText").textContent = rateText;
      document.getElementById("avgBalance").textContent =
        formatNumber(avg) + " 元";
      document.getElementById("formulaText").textContent =
        "違約金 ＝ 結清前每月底借款餘額平均數 × " + rateText;

      resultEl.style.display = "block";
    }

    function resetForm() {
      document.getElementById("customerName").value = "";
      document.getElementById("disburseDate").value = "";
      document.getElementById("prepayDate").value = "";
      for (let i = 1; i <= 6; i++) {
        document.getElementById("bal" + i).value = "";
      }
      document.getElementById("error").style.display = "none";
      document.getElementById("result").style.display = "none";
    }

    function setupCurrencyInputs() {
      const inputs = document.querySelectorAll(".currency-input");
      inputs.forEach(input => {
        input.addEventListener("focus", (e) => {
          const raw = e.target.value.replace(/,/g, "");
          e.target.value = raw;
        });
        input.addEventListener("blur", (e) => {
          const raw = e.target.value.replace(/,/g, "");
          if (raw === "") {
            e.target.value = "";
            return;
          }
          const num = parseFloat(raw);
          if (isNaN(num)) {
            e.target.value = "";
            return;
          }
          e.target.value = formatNumber(num);
        });
      });
    }

    document.addEventListener("DOMContentLoaded", setupCurrencyInputs);
  </script>
</body>
</html>
